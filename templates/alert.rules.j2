groups:
  - name: default
    rules:
    - alert: TCPCheckFailed
      for: 10s
      expr: "probe_success{job='tcpcheck'} == 0"
      labels:
        severity: low
        service: "{% raw %}{{ $labels.service }}{% endraw %}"
        host: "{% raw %}{{ $labels.host }}{% endraw %}"
        instance: "{% raw %}{{ $labels.instance }}{% endraw %}"
      annotations:
        message: "{% raw %}{{ $labels.service}} {{ $labels.dimension }} on {{ $labels.host }}: TCP check failed{% endraw %}"

    # Score check alert definitions
    - alert: ScoreCheckFailed
      expr: netdata_openio_score__average == 0
      for: 10s
      labels:
        host: "{% raw %}{{ $labels.instance }}{% endraw %}"
        instance: "{% raw %}{{ $labels.s_instance }}{% endraw %}"
        service: "{% raw %}{{ $labels.service }}{% endraw %}"
        severity: low
      annotations:
        message: "{% raw %}{{ $labels.service }} {{ $labels.s_instance }} on {{ $labels.host }}: Score is 0{% endraw %}"

    # Per service check alert definitions
    {% for service in prometheus_blackbox_services -%}
    - alert: {{ service }}HealthCheck
      expr: probe_success{job='{{ service }}'} == 0
      for: 10s
      labels:
        host: "{% raw %}{{ $labels.instance }}{% endraw %}"
        instance: "{% raw %}{{ $labels.instance }}{% endraw %}"
        service: "{{ service }}"
        severity: low
      annotations:
        message: "{% raw %}{{ $labels.service }} {{ $labels.instance }} on {{ $labels.host }}: Health check failed{% endraw %}"
    {% endfor %}

    # RAWX: too many 4xx
    - alert: RawxClientErrorsRatio
      expr: "sum(netdata_openio_rep_hits_4xx__average) by (instance, dimension) / (sum(netdata_openio_rep_hits_2xx__average) by (instance, dimension) + 1) > 0.10"
      for: 10s
      labels:
        host: "{% raw %}{{ $labels.instance }}{% endraw %}"
        instance: "{% raw %}{{ $labels.s_instance }}{% endraw %}"
        service: "rawx"
        severity: low
      annotations:
        message: "{% raw %}{{ $labels.service }} {{ $labels.s_instance }} on {{ $labels.host }}: Client error (4xx) ratio too high{% endraw %}"

    # RAWX: 5xx errors
    - alert: RawxServerErrors
      expr: "netdata_openio_rep_hits_5xx__average > 0"
      for: 10s
      labels:
        host: "{% raw %}{{ $labels.instance }}{% endraw %}"
        instance: "{% raw %}{{ $labels.s_instance }}{% endraw %}"
        service: "rawx"
        severity: low
      annotations:
        message: "{% raw %}{{ $labels.service }} {{ $labels.s_instance }} on {{ $labels.host }}: Service returned server errors{% endraw %}"
